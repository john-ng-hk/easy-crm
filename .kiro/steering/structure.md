# Project Structure

## Directory Organization

```
easy-crm/
├── .kiro/                          # Kiro configuration
│   ├── specs/                      # Feature specifications
│   │   ├── lead-management-system/ # Lead management system spec
│   │   └── duplicate-lead-handling/ # Duplicate lead handling specification
│   └── steering/                   # AI assistant guidance rules
│       ├── tech.md                 # Technology stack and dependencies
│       ├── structure.md            # Project structure and organization
│       ├── product.md              # Product overview and features
│       ├── infrastructure.md       # Infrastructure and deployment guide
│       ├── deployment.md           # Deployment and maintenance guide
│       ├── testing.md              # Testing guidelines and strategies
│       └── batch-processing.md     # Batch processing architecture guide
├── infrastructure/                 # CloudFormation templates
│   ├── main.yaml                   # Root stack template (orchestrates all nested stacks)
│   ├── storage.yaml               # DynamoDB table with GSIs and S3 buckets
│   ├── cognito.yaml               # User Pool, Identity Pool, and IAM roles
│   ├── lambda.yaml                # Lambda functions with IAM roles and permissions
│   ├── api-gateway.yaml           # REST API with CORS and Cognito authorization
│   ├── cloudfront.yaml            # CDN distribution with SSL certificate support
│   └── README.md                  # Infrastructure documentation and deployment guide
├── lambda/                        # Lambda function source code
│   ├── shared/                    # Common utilities and models
│   │   ├── __init__.py
│   │   ├── dynamodb_utils.py      # DynamoDB operations with phone field and duplicate handling support
│   │   ├── validation.py          # Input validation utilities with phone validation
│   │   ├── error_handling.py      # Error handling and logging
│   │   ├── email_utils.py         # Email normalization and validation for duplicate detection
│   │   └── requirements.txt       # Shared dependencies
│   ├── file-upload/               # Presigned S3 URL generation
│   │   ├── lambda_function.py
│   │   ├── requirements.txt
│   │   └── README.md              # Function documentation
│   ├── lead-splitter/             # File processing and batch creation with multi-worksheet Excel support
│   │   ├── lambda_function.py
│   │   └── requirements.txt
│   ├── deepseek-caller/           # DeepSeek integration for data standardization with duplicate detection
│   │   ├── lambda_function.py
│   │   └── requirements.txt
│   ├── lead-reader/               # Lead retrieval with filtering/pagination and phone field support
│   │   ├── lambda_function.py
│   │   └── requirements.txt
│   ├── lead-exporter/             # CSV export functionality with phone field support
│   │   ├── lambda_function.py
│   │   └── requirements.txt
│   ├── chatbot/                   # Natural language query processing with phone field support
│   │   ├── lambda_function.py
│   │   └── requirements.txt
│   └── README.md                  # Lambda functions overview
├── frontend/                      # Static web application
│   ├── css/                       # Tailwind CSS styles
│   │   └── styles.css             # Main stylesheet with Tailwind utilities
│   ├── js/                        # JavaScript modules
│   │   ├── app.js                 # Main application initialization
│   │   ├── auth.js                # Cognito authentication handling
│   │   ├── api.js                 # API communication layer
│   │   ├── config.js              # Configuration management
│   │   ├── leads.js               # Lead management functionality
│   │   ├── upload.js              # File upload handling
│   │   └── chat.js                # Natural language chat interface
│   ├── index.html                 # Main application page
│   ├── config.json                # Runtime configuration (generated by deployment)
│   └── assets/                    # Static assets (images, icons)
├── tests/                         # Test suite
│   ├── unit/                      # Unit tests for Lambda functions (including phone field and multi-worksheet tests)
│   ├── integration/               # API integration tests (including phone field, duplicate handling, and progress update tests)
│   │   └── test_progress_update_fix.py # Progress indicator fixes validation
│   ├── e2e/                       # End-to-end tests (including phone field and duplicate handling E2E tests)
│   ├── performance/               # Performance and load tests (including duplicate handling performance)
│   ├── security/                  # Security validation tests
│   ├── conftest.py                # Pytest configuration and fixtures
│   ├── validate_tests.py          # Test validation utilities
│   ├── run_auth_tests.py          # Authentication test runner
│   ├── run_comprehensive_tests.py # Comprehensive test suite runner
│   ├── run_duplicate_handling_e2e_tests.py # Duplicate handling E2E test runner
│   ├── validate_duplicate_handling_integration.py # Duplicate handling integration validator
│   └── README.md                  # Testing documentation
├── scripts/                       # Deployment and utility scripts
│   ├── deploy.sh                  # Interactive deployment script with parameter prompts
│   ├── deploy-frontend.sh         # Frontend deployment and cache invalidation script
│   ├── package-lambdas.sh         # Lambda packaging and deployment script
│   ├── validate-templates.sh      # CloudFormation template validation script
│   ├── validate-deployment.sh     # Post-deployment validation script
│   ├── smoke-tests.sh             # Smoke testing script for deployed resources
│   ├── validate-duplicate-handling.sh # Duplicate handling validation script
│   ├── verify-duplicate-handling-config.sh # Duplicate handling configuration verification
│   └── invalidate-cache.sh        # CloudFront cache invalidation script
├── config/                        # Configuration files
│   ├── deployment.yaml            # Deployment configuration and validation rules
│   └── environments/              # Environment-specific configurations
├── docs/                          # Additional documentation
│   ├── authentication.md          # Authentication and security documentation
│   ├── batch-processing-architecture.md # Batch processing architecture guide
│   ├── deployment-guide.md        # Comprehensive deployment guide
│   └── deployment-troubleshooting.md # Deployment troubleshooting guide
├── requirements.txt               # Root Python dependencies
├── pytest.ini                    # Pytest configuration
├── .gitignore                     # Git ignore rules (comprehensive)
├── .coverage                      # Test coverage data
├── easy-crm-test.xlsx            # Test data file for DeepSeek integration
├── test-leads-excel.csv          # Additional test data
├── CLEANUP_SUMMARY.md            # Migration summary (file-formatter to batch processing)
├── PHONE_FIELD_INTEGRATION_TEST_SUMMARY.md # Phone field testing summary
├── test_report.json              # Test execution reports
├── test_report.txt               # Test execution reports (text format)
├── PROGRESS_INDICATOR_FIXES_SUMMARY.md # Progress indicator fixes documentation
└── README.md                      # Project documentation
```

## File Naming Conventions

### Lambda Functions

- Directory names use kebab-case: `file-upload`, `lead-reader`
- Python files use snake_case: `lambda_function.py`, `dynamodb_utils.py`
- Each Lambda has its own `requirements.txt` for dependencies

### Frontend Files

- HTML/CSS/JS files use kebab-case: `index.html`, `styles.css`
- JavaScript modules use camelCase for functions and variables
- Component-based organization by functionality

### Infrastructure

- CloudFormation templates use kebab-case: `api-gateway.yaml`
- Resource names use PascalCase in templates: `LeadsTable`, `FileUploadFunction`
- Parameter names use PascalCase: `DeepSeekApiKey`, `DomainName`

## Code Organization Principles

### Lambda Function Organization

- Each function is self-contained with minimal dependencies
- Shared utilities in `lambda/shared/` to avoid code duplication
- Environment-specific configuration via environment variables
- Consistent error handling and logging patterns
- **Batch processing architecture** with SQS for scalability and reliability
- **Multi-worksheet Excel support** for processing all worksheets automatically
- **Duplicate lead handling** with email-based detection and automatic updates
- **Phone field support** integrated across all functions
- **AWS Pandas Layer** for Excel processing without numpy conflicts
- **Dead Letter Queue** for failed message handling
- **Email normalization** for consistent duplicate detection

### Frontend Architecture

- Modular JavaScript with clear separation of concerns
- No build process required - direct browser compatibility
- Progressive enhancement for better user experience
- Responsive design using Tailwind utility classes

### Infrastructure Templates

- Nested CloudFormation stacks for modularity and maintainability
- Clear parameter passing between stacks with proper dependencies
- Consistent resource naming and tagging across all resources
- Environment-agnostic templates with parameters for flexibility
- S3-hosted nested templates for reliable deployment
- Comprehensive outputs for cross-stack references

## Development Workflow

1. **Local Development**: Use Python virtual environments for Lambda development
2. **Template Validation**: Run `./scripts/validate-templates.sh` to validate CloudFormation syntax
3. **Infrastructure Deployment**: Run `./scripts/deploy.sh` for interactive deployment with parameter prompts
4. **Lambda Code Deployment**: Run `./scripts/package-lambdas.sh` to package and deploy function code
5. **Frontend Deployment**: Run `./scripts/deploy-frontend.sh` to upload static files and invalidate cache
6. **Testing**: Run unit and integration tests using pytest

## Current Status

✅ **Infrastructure**: Fully deployed and operational  
✅ **Lambda Functions**: All 6 functions deployed and working (migrated to batch processing)  
✅ **Frontend**: Deployed with working authentication, lead management, and phone field support  
✅ **API Gateway**: Configured with proper CORS and Cognito authorization  
✅ **Database**: DynamoDB table with GSIs for efficient querying and phone field support  
✅ **File Storage**: S3 buckets for file uploads and website hosting  
✅ **CDN**: CloudFront distribution with custom domain and SSL  
✅ **Batch Processing**: SQS-based batch processing for scalable file processing  
✅ **Multi-Worksheet Excel**: Complete support for processing all worksheets in Excel files  
✅ **Duplicate Lead Handling**: Email-based duplicate detection and automatic lead updates  
✅ **Phone Field Integration**: Complete phone field support across all components  
✅ **Testing Suite**: Comprehensive unit, integration, and E2E tests (36+ tests passing)  
✅ **Pagination**: Fixed page-based pagination working correctly across all components (production verified)  
✅ **Progress Indicators**: Multi-batch progress updates working with cost-optimized polling (10s intervals)  

### Deployment Order

1. Validate all CloudFormation templates
2. Deploy infrastructure stack (creates all AWS resources)
3. Deploy Lambda function code (updates function code)
4. Upload frontend files to S3 website bucket
5. Test application functionality end-to-end

## Recent Updates (September 2025)

### Batch Completion Race Condition Fix
- **BATCH_COMPLETION_RACE_CONDITION_FIX.md**: Technical analysis and atomic operations solution
- **DEPLOYMENT_SUMMARY_BATCH_COMPLETION_FIX.md**: Comprehensive deployment guide
- **DEPLOYMENT_VERIFICATION_BATCH_COMPLETION_FIX.md**: Post-deployment verification results
- **atomic_status_service.py**: New atomic operations service for race condition prevention

### Files Added
- **Atomic operations**: `lambda/shared/atomic_status_service.py` (atomic batch completion)
- **Atomic tests**: `tests/integration/test_atomic_batch_completion.py` (5 test cases)
- **Race condition tests**: `tests/integration/test_concurrent_batch_completion.py`
- **E2E validation**: `tests/e2e/test_batch_completion_race_condition_fix.py`
- **API enhancement**: New `/force-complete` endpoint in API Gateway

### Infrastructure Updates
- **Enhanced Lambda functions**: DeepSeek caller and status reader with atomic operations
- **API Gateway**: New recovery endpoint for stuck processing scenarios
- **Comprehensive testing**: 41+ tests total (36 existing + 5 new atomic tests)
- **Documentation**: Complete technical and deployment documentation

### Previous Updates (January 2025)
- **Progress fix tests**: `tests/integration/test_progress_update_fix.py` (5 test cases)
- **Fix documentation**: `PROGRESS_INDICATOR_FIXES_SUMMARY.md`
- **Frontend optimization**: Polling reduced from 2s to 10s with 5-minute timeout